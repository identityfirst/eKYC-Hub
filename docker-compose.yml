version: '3'
services:
  keycloak-ekyc:
    build:
      context: keycloak-eKYC-plugin
      dockerfile: Dockerfile
    depends_on:
      - mysql
    ports:
      - 8080:8080
      - 8787:8787
      - 8443:8443
    environment:
      - KEYCLOAK_USER=admin
      - KEYCLOAK_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KEYCLOAK_IMPORT=/tmp/demo-realm.json
      - IDV_URL=http://${IDV_HUB_DOMAIN:-idv-hub}:5000
      - IDV_HTTPS_URL=https://${IDV_HUB_DOMAIN:-idv-hub}:5443
      - DEBUG=true
      - DEBUG_PORT=*:8787
      - DB_VENDOR=mysql
      - DB_ADDRESS=mysql:3306
      - DB_USER=keycloak
      - DB_PASSWORD=${MYSQL_USER_PASSWORD:-keycloak}
    volumes:
      - ./demo-realm.json:/tmp/demo-realm.json
      - ${KEYCLOAK_TLS_CERT_PATH:-./tls.crt}:/etc/x509/https/tls.crt
      - ${KEYCLOAK_TLS_KEY_PATH:-./tls.key}:/etc/x509/https/tls.key
    healthcheck:
      test: "curl -f http://localhost:8080/auth/realms/master/.well-known/openid-configuration || false"
      timeout: 120s
  demo-rp:
    build:
      context: keycloak-eKYC-demo-RP
      dockerfile: Dockerfile
    depends_on:
    - keycloak-ekyc
    environment:
      - IDP_URL=https://${KEYCLOAK_DOMAIN:-keycloak-ekyc}:8443
      - SELF_URL=http://${DEMO_RP_DOMAIN:-demo-rp}:${DEMO_RP_PORT:-3000}
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - CLIENT_ID=${DEMO_RP_CLIENT_ID:-demo-rp}
      - CLIENT_SECRET=${DEMO_RP_CLIENT_SECRET:-secret}
    ports:
      - ${DEMO_RP_PORT:-3000}:3000
  idv-hub:
    build:
      context: idv-hub
      dockerfile: Dockerfile
    depends_on:
    - keycloak-ekyc
    environment:
      - APP_ID=idv-hub
      - PORT=5000
      - SSL_PORT=5443
      - LOG_LEVEL=debug
      - REQUEST_LIMIT=100kb
      - SESSION_SECRET=mySecret
      - OPENAPI_SPEC=/api/v1/spec
      - PASSBASE_SECRET_KEY=${PASSBASE_SECRET_KEY}
      - PASSBASE_PUBLIC_KEY=${PASSBASE_PUBLIC_KEY}
      - SELF_HOST=https://${IDV_HUB_DOMAIN:-idv-hub}:5443
      - OIDC_IDP_URL=https://${KEYCLOAK_DOMAIN:-keycloak-ekyc}:8443/auth/realms/demo
      - OIDC_SCOPES=openid email profile
      - OIDC_CLIENT_ID=idv-hub
      - OIDC_CLIENT_SECRET=secret
      - OIDC_RESPONSE_TYPE=code
      - MONGO_URL=mongodb://mongo:27017
      - MONGO_DB=ekyc
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    ports:
      - 5000:5000
      - 5443:5443
    volumes:
      - ${IDV_HUB_TLS_CERT_PATH:-./idv-tls.crt}:/app/dist/idv-tls.crt
      - ${IDV_HUB_TLS_KEY_PATH:-./idv-tls.key}:/app/dist/idv-tls.key
  mongo:
    image: mongo
    environment:
      - MONGO_INITDB_DATABASE=ekyc
    volumes:
      - ekycmongo:/data/db
    ports:
      - 27017:27017

  mysql:
    image: mysql
    environment:
      - MYSQL_DATABASE=keycloak
      - MYSQL_USER=keycloak
      - MYSQL_PASSWORD=${MYSQL_USER_PASSWORD:-keycloak}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-admin}
    volumes:
      - ekycmysql:/var/lib/mysql
    ports:
      - 3306:3306

volumes:
  ekycmysql:
  ekycmongo:
